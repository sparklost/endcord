name: Build and Publish Debian Repository

on:
  schedule:
    - cron: '0 2 * * *'  # Runs at 2:00 AM UTC daily
  workflow_dispatch:     # Allows manual trigger

jobs:
  build-and-publish:
    runs-on: ubuntu-24.04  # Closest match to Debian Trixie glibc
    permissions:
      contents: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for merging
          path: endcord

      - name: Sync with Upstream
        working-directory: ./endcord
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Add upstream remote
          git remote add upstream https://github.com/sparklost/endcord.git
          git fetch upstream

          # Check if we're behind upstream
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          if [ "$BEHIND" -gt 0 ]; then
            echo "Merging $BEHIND commit(s) from upstream..."
            git merge upstream/main -m "Merge upstream/main: sync with sparklost/endcord"

            # Restore fork README additions if overwritten
            if [ -f "scripts/restore-fork-readme.sh" ]; then
              chmod +x scripts/restore-fork-readme.sh
              ./scripts/restore-fork-readme.sh || true
              git add README.md 2>/dev/null || true
              git diff --cached --quiet || git commit -m "Restore fork README additions after upstream merge"
            fi

            # Push merged changes back to fork
            git push origin main
          else
            echo "Already up to date with upstream."
          fi

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev build-essential dpkg-dev apt-utils clang libncurses-dev

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.7.14"
          enable-cache: false

      - name: Setup GPG
        id: setup-gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Build Binary (PyInstaller)
        # We use PyInstaller here because Nuitka is very slow on free CI runners and may timeout.
        # If you have paid runners, change this to: uv run build.py --nuitka
        # Default is single-file build (no --onedir flag)
        working-directory: ./endcord
        run: |
          uv sync --group build
          uv run build.py

      - name: Prepare Debian Package Structure
        id: prep
        run: |
          # Define version based on upstream version + date
          cd endcord
          BASE_VER=$(grep 'version =' pyproject.toml | head -1 | cut -d '"' -f 2)
          DATE_TAG=$(date +%Y%m%d)
          FULL_VER="${BASE_VER}-nightly${DATE_TAG}"
          echo "VERSION=$FULL_VER" >> $GITHUB_ENV

          # Create Staging Area
          mkdir -p ../deb-build/endcord_${FULL_VER}_amd64/usr/bin
          mkdir -p ../deb-build/endcord_${FULL_VER}_amd64/usr/share/applications
          mkdir -p ../deb-build/endcord_${FULL_VER}_amd64/DEBIAN

          # Copy Binary
          cp dist/endcord ../deb-build/endcord_${FULL_VER}_amd64/usr/bin/endcord
          chmod +x ../deb-build/endcord_${FULL_VER}_amd64/usr/bin/endcord

      - name: Generate Control and Desktop Files
        working-directory: ./deb-build
        run: |
          PKG_DIR="endcord_${{ env.VERSION }}_amd64"

          # 1. Control File
          {
            echo "Package: endcord"
            echo "Version: ${{ env.VERSION }}"
            echo "Architecture: amd64"
            echo "Maintainer: Endcord Fork Maintainer <no-reply@github.com>"
            echo "Installed-Size: $(du -ks "$PKG_DIR/usr" | cut -f1)"
            echo "Section: net"
            echo "Priority: optional"
            echo "Homepage: https://github.com/sparklost/endcord"
            echo "Description: Feature rich Discord TUI client (Unofficial Community Repack)"
            echo " This is an unofficial community repack of Endcord for easier Debian installation."
            echo " Packaged by fans - Not affiliated with or endorsed by the official Endcord team."
            echo " Upstream project: https://github.com/sparklost/endcord"
          } > "$PKG_DIR/DEBIAN/control"

          # 2. Desktop Entry
          {
            echo "[Desktop Entry]"
            echo "Name=Endcord"
            echo "Exec=/usr/bin/endcord"
            echo "Type=Application"
            echo "Terminal=true"
            echo "Categories=Network;Chat;"
            echo "Keywords=discord;tui;"
            echo "Comment=Discord TUI Client"
          } > "$PKG_DIR/usr/share/applications/endcord.desktop"

      - name: Build .deb
        working-directory: ./deb-build
        run: dpkg-deb --build --root-owner-group endcord_${{ env.VERSION }}_amd64

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo
          fetch-depth: 0
        continue-on-error: true  # Might fail if branch doesn't exist yet

      - name: Update Apt Repository
        run: |
          REMOTE_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

          # Initialize gh-pages if it doesn't exist or checkout failed
          if [ ! -d "gh-pages-repo/.git" ]; then
            mkdir -p gh-pages-repo
            cd gh-pages-repo
            git init
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git remote add origin "$REMOTE_URL"
          else
            cd gh-pages-repo
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git remote set-url origin "$REMOTE_URL" || git remote add origin "$REMOTE_URL"
          fi

          # Setup Repo Structure
          mkdir -p pool/main
          mkdir -p dists/stable/main/binary-amd64

          # Create index.html for root URL
          cat > index.html << 'INDEXEOF'
          <!DOCTYPE html>
          <html>
          <head><title>Endcord APT Repository</title>
          <style>body{font-family:system-ui;max-width:700px;margin:50px auto;padding:20px;line-height:1.6}
          pre{background:#f4f4f4;padding:15px;overflow-x:auto;border-radius:5px}</style>
          </head>
          <body>
          <h1>Endcord APT Repository</h1>
          <p>Unofficial community repack of <a href="https://github.com/sparklost/endcord">Endcord</a> for Debian/Ubuntu.</p>
          <h2>Quick Install</h2>
          <pre>wget -qO - https://oichkatzelesfrettschen.github.io/endcord/public.key | sudo gpg --dearmor -o /etc/apt/keyrings/endcord-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/endcord-archive-keyring.gpg arch=amd64] https://oichkatzelesfrettschen.github.io/endcord/ stable main" | sudo tee /etc/apt/sources.list.d/endcord.list
          sudo apt update && sudo apt install endcord</pre>
          <h2>Files</h2>
          <ul><li><a href="public.key">GPG Public Key</a></li>
          <li><a href="dists/stable/Release">Release</a></li>
          <li><a href="dists/stable/main/binary-amd64/Packages">Packages</a></li></ul>
          <p><small>Not affiliated with the official Endcord team.</small></p>
          </body></html>
          INDEXEOF

          # Move new deb file to pool
          cp ../deb-build/*.deb pool/main/

          # Generate Packages file (run from repo root for correct paths)
          apt-ftparchive packages pool/main > dists/stable/main/binary-amd64/Packages
          gzip -9 -k -f dists/stable/main/binary-amd64/Packages
          cd dists/stable

          # Generate Release file
          {
            echo "Origin: Endcord-Unofficial"
            echo "Label: Endcord Community Repack"
            echo "Suite: stable"
            echo "Codename: stable"
            echo "Architectures: amd64"
            echo "Components: main"
            echo "Description: Unofficial community repack of Endcord - Not affiliated with the official Endcord team"
            echo "Date: $(date -R)"
          } > Release

          # Generate Hashes for Release
          apt-ftparchive release . >> Release

          # Sign the Release
          rm -f Release.gpg InRelease
          gpg --default-key ${{ steps.setup-gpg.outputs.keyid }} -abs -o Release.gpg Release
          gpg --default-key ${{ steps.setup-gpg.outputs.keyid }} --clearsign -o InRelease Release

          # Return to gh-pages-repo root (we're in dists/stable)
          cd ../..

          # Deploy
          git add .
          git commit -m "Update repo with version ${{ env.VERSION }}" || echo "No changes to commit"
          # Push HEAD to remote gh-pages (works even if local branch has different name)
          git push --force origin HEAD:gh-pages
